<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse and Bull - Vaquejada</title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    
    <script src="src/scripts/mattress.js"></script>
    <script src="src/scripts/script.js"></script>

    <script src="src/scripts/vqjdState.js"></script>

    <script>

    const ctx = mattress.createCanvas()
    mattress.fullScrean()
    mattress.center()

    let event = ""

    let playerData = ""
    let horse = ""
    let horseVelocity = 0
    let selectedMode = ""

    let game = ""

    const sounds = [
        "relincho",
        "cavalgada"
    ]

    const soundSrc = [
        "src/sounds/HORSE.wav",
        "src/sounds/HORSEGAL.wav"
    ]

    const imgs = {
        sky: new Image(),
        scene: new Image(),
        point: new Image(),
        player: new Image(),
        horse: new Image()
    }

    const STATE = {
        awaitTwoPlayers:1,
        ready: 2,
        steady: 3,
        run:4
    }

    let thisState = STATE.awaitTwoPlayers

    const scene = {
        x: 0,
        y: 0,
        width: 5520,
        height: mattress.cnv.height,
        srcX: 0,
        srcY: 0,
        srcWidth: 11520,
        srcHeight: 1080,
        velocity:4.5,

        draw() {
            ctx.drawImage(imgs.scene, this.srcX, this.srcY, this.srcWidth, this.srcHeight, this.x, this.y, this.width, this.height)
        },

        update() {
            if(thisState === STATE.run){
                if(this.x >= -this.width+800){
                    this.x -= this.velocity
                }
            }
        }

    }

    class Player{
        constructor() {
            this.srcX = 0
            this.srcY = 0
            this.srcWidth = 454
            this.srcHeight = 340
            this.x = 30
            this.y = mattress.cnv.height - 277
            this.width = 320
            this.height = 270
            this.timer = 0
            this.velocity = 4
        }

        draw(x, y) {
            ctx.drawImage(imgs.player, this.srcX, this.srcY, this.srcWidth, this.srcHeight, this.x + x, this.y + y, this.width, this.height)
        }

        update() {

            this.timer++

            if(this.timer >= this.velocity*12) {
                this.timer = 0
            }

            if(thisState === STATE.run){
                imgs.player.src = `img/${horse.nome}_vaquejada.png`
            }

            this.srcX = Math.floor(this.timer / this.velocity) * this.srcWidth
        }

    }

    const players = [
        new Player()
    ]

    function state_Update() {

        const room = {}

        function seeState(rooms) {
            console.log("chamou")
            if(Object.keys(rooms[room.thisRoom]).length === 2){
                thisState = STATE.ready
                console.log("Existem dois players")
                players.push(new Player())
            }else{
                console.log("Existe um player")
                thisState = STATE.awaitTwoPlayers
                players.splice(1, 1)
            }
        }

        function findMyRoom(rooms){
            for(let thisRoom  = 0; thisRoom < rooms.length; thisRoom++){
                const r = rooms[thisRoom]
                const playerId = game.stateOBS.playerId
                if(r[playerId]){
                    Object.assign(room, {thisRoom})
                    return room
                }
            }
        }

        return {
            findMyRoom,
            seeState
        }
    }

    let thisRoom = ""

    setTimeout(async () => {
        const stateUpdate = state_Update()
        thisRoom = await stateUpdate.findMyRoom(game.state.rooms)
        setInterval(()=>{
            stateUpdate.seeState(game.state.rooms)
            game.analyseForDestroyAloneRooms()
        }, 200)
    }, 600)

    async function initGame(data) {
        playerData = await data[0]
        _playerData = data[0]
        horse = await JSON.parse(playerData.principalAnimal)
        horseVelocity = horse.velocidade
        selectedMode = await localStorage.getItem("selectedMode")
        imgs.sky.src = "img/sky.png"
        imgs.scene.src = "img/vqjdScene.png"
        imgs.player.src = `img/${horse.nome}_vaquejada_Stay.png`
        game = createGame()
        server()
        init()
    }

    const checkPlayers = () => {
        if(players.length === 1){
            ctx.fillStyle = "black"
            ctx.font = "25px Arial"
            ctx.fillText("AGUARDANDO SEGUNDO PLAYER", mattress.cnv.width/2-mattress.cnv.width/4, mattress.cnv.height/2)
        }
    }

    function init() {
        requestAnimationFrame(init, mattress.cnv)
        mattress.fullScrean()
        update()
        draw()
    }

    function draw() {
        mattress.clear()
        mattress.drawBackground(imgs.sky)
        scene.draw()
        if(players[1]){
            ctx.globalAlpha = 0.8
            players[1].draw(4, -14)
        }
        if(players[0]){
            ctx.globalAlpha = 1
            players[0].draw(-13, 20)
        }
        checkPlayers()
    }

    function update() {
        if(thisState === STATE.run){
            scene.update()
            for(const player in players){
                players[player].update()
            }
        }
    }

    function server() {

        const socket = io()

        socket.on("connect", () => {
            const playerId = socket.id
            console.log(`Player connected on server with as ${playerId}`)

            socket.on("setup", (state) => {
                game.setState(state)
            })

            socket.on("add-player", (command) => {
                game.addPlayer(command)
            })

            socket.on("remove-player", (command) => {
                game.removePlayer(command)
            })

            socket.on("delete-room", (command) => {
                game.analyseForDestroyAloneRooms()
                socket.emit("delete-room", {type:"delete-room"})
            })

        })

    }

    </script>

</body>
</html>