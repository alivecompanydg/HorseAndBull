<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse and Bull - Vaquejada</title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    
    <script src="src/scripts/mattress.js"></script>
    <script src="src/scripts/script.js"></script>

    <script src="src/scripts/vqjdState.js"></script>

    <script>

    const ctx = mattress.createCanvas()
    mattress.fullScrean()
    mattress.center()

    let event = ""

    let playerData = ""
    let horse = ""
    let horseVelocity = 0
    let selectedMode = ""

    let game = ""

    const sounds = [
        "relincho",
        "cavalgada"
    ]

    const soundSrc = [
        "src/sounds/HORSE.wav",
        "src/sounds/HORSEGAL.wav"
    ]

    const imgs = {
        sky: new Image(),
        scene: new Image(),
        point: new Image(),
        player: new Image(),
        horse: new Image()
    }

    const STATE = {
        ready: 1,
        steady: 2,
        run:3
    }

    let thisState = STATE.ready

    const scene = {
        x: 0,
        y: 0,
        width: 5520,
        height: mattress.cnv.height,
        srcX: 0,
        srcY: 0,
        srcWidth: 11520,
        srcHeight: 1080,
        velocity:4.5,

        draw() {
            ctx.drawImage(imgs.scene, this.srcX, this.srcY, this.srcWidth, this.srcHeight, this.x, this.y, this.width, this.height)
        },

        update() {
            if(thisState === STATE.run){
                if(this.x >= -this.width+800){
                    this.x -= this.velocity
                }
            }
        }

    }

    const player = {
        srcX: 0,
        srcY: 0,
        srcWidth: 454,
        srcHeight: 340,
        x: 30,
        y: mattress.cnv.height - 277,
        width: 320,
        height: 270,
        timer: 0,
        velocity: 4,

        draw() {
            ctx.drawImage(imgs.player, this.srcX, this.srcY, this.srcWidth, this.srcHeight, this.x, this.y, this.width, this.height)
        },

        update() {

            this.timer++

            if(this.timer >= this.velocity*12) {
                this.timer = 0
            }

            this.srcX = Math.floor(this.timer / this.velocity) * this.srcWidth
        }
    }

    async function initGame(data) {
        playerData = await data[0]
        horse = await JSON.parse(playerData.principalAnimal)
        horseVelocity = horse.velocidade
        selectedMode = await localStorage.getItem("selectedMode")
        imgs.sky.src = "img/sky.png"
        imgs.scene.src = "img/vqjdScene.png"
        imgs.player.src = `img/${horse.nome}_vaquejada.png`
        game = createGame()
        server()
        init()
    }

    function init() {
        requestAnimationFrame(init, mattress.cnv)
        mattress.fullScrean()
        update()
        draw()
    }

    function draw() {
        mattress.clear()
        mattress.drawBackground(imgs.sky)
        scene.draw()
        player.draw()
    }

    function update() {
        scene.update()
        player.update()
    }

    function server() {

        const socket = io()

        socket.on("connect", () => {
            const playerId = socket.id
            console.log(`Player connected on server with as ${playerId}`)

            socket.on("setup", (state) => {
                game.setState(state)
            })

            socket.on("add-player", (command) => {
                game.addPlayer(command)
            })

        })

    }

    </script>

</body>
</html>